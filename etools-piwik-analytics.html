<link rel="import" href="../polymer/polymer.html">

<script>
  const SITE_ID = function() {
    switch(window.location.host) {
      case "etools.unicef.org":
        return '1'
        break;
      case "etools-dev.unicef.org":
        return '2'
        break;
      case "etools-staging.unicef.org":
        return '4'
        break;
    }
  }();

  // _paq array initialization and tracking script
  var _paq = _paq || [];
  _paq.push(["trackPageView"]);
  _paq.push(['trackAllContentImpressions']);
  _paq.push(["enableLinkTracking"]);
  _paq.push(["enableHeartBeatTimer"]);
  (function () {
    var u="//unisitetracker.azurewebsites.net/";
    _paq.push(["setTrackerUrl", u + "piwik.php"]);
    _paq.push(["setSiteId", SITE_ID]);
    var d = document, g = d.createElement("script"), s = d.getElementsByTagName("script")[0];
    g.type = "text/javascript"; g.defer = true; g.async = true; g.src = u + "piwik.js";
    s.parentNode.insertBefore(g, s);
  })();
</script>

<dom-module id="etools-piwik-analytics">
  <script>
    Polymer({
      is: 'etools-piwik-analytics',
      properties: {
        page: {
          type: String,
          observer: 'pageView'
        },
        queryEntered: {
          type: Boolean,
          value: false
        },
        toast: {
          type: String,
          observer: 'toastFired',
        },
        initialLoad: {
          type: Boolean,
          value: false
        }
      },

      // sets global event listeners, sets global error listener
      attached: function() {
        document.addEventListener('tap', this.trackEvent.bind(this));
        document.addEventListener('keyup', this.typing.bind(this));
        // window.onerror = this.error
      },

      toastFired: function() {
        if (!!this.toast) {
          _paq.push([
            'trackEvent',
            'toast notification',
            this.page,
            this.toast
          ])
        }
      },

      // tracks exports and filtering
      trackEvent: function(e) {
        switch (e.detail.sourceEvent.currentTarget.innerText) {
        // tracks document exports
          case 'EXPORT':
            _paq.push([
              'trackEvent',
              'export',
              this.page,
              this.user.groups.map(function(g) {
                return g.name
              })
            ])
            break
          // tracks filtered charts on dashboard/trips
          case 'GET CHART':
            _paq.push([
              'trackEvent',
              'chart filtered',
              this.page,
              this.user.groups.map(function(g) {
                return g.name
              })
            ])
            break
          // tracks drop-down filtering in PMP
          case 'ADD FILTER':
            _paq.push([
              'trackEvent',
              'chart filtered',
              this.page,
              this.user.groups.map(function(g) {
                return g.name
              })
            ])
        }
      },

      // checks if typing is in relevant input field, tracks search bar filtering
      typing: function(event) {
        // events have different properties in IE vs Chrome; checks both
        var val = event.path ? !!event.path[0].value : !!event.target.value
        var id = event.path && event.path[7] ? event.path[7].id === "query" : event.target.id === "input"
        if (val && id && this.queryEntered === false) {
          _paq.push([
            'trackEvent',
            'search bar used',
            this.page,
            this.user.groups.map(function(g) {
              return g.name
            })
          ])
          this.set('queryEntered', true)
        }
      },

      // tracks internal pageviews that aren't picked up with trackPageView
      pageView: function() {
        if (this.initialLoad) {
          _paq.push([
            'trackEvent',
            'in-app navigation',
            this.page,
            'tap',
          ])
        };
        this.initialLoad = true;
      },

      // following is a function that is disabled pending review
      // handles tracking javascript error messages
      // error: function (msg, url, lineNo, columnNo, error) {
      //   var message = [
      //     'Message: ' + msg,
      //     'URL: ' + url,
      //     'Line: ' + lineNo,
      //     'Column: ' + columnNo,
      //     'Error object: ' + JSON.stringify(error)
      //   ].join(' - ');
      //   _paq.push(['trackEvent', 'error', 'javascript error', message])
      // },
    });
  </script>
</dom-module>
